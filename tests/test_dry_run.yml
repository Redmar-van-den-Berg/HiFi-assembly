- name: dry-run-vanilla
  tags:
    - dry-run
  command: >
    snakemake
      --dryrun
      --reason
      --printshellcmds
      --config pepfile=tests/pep/project_config.yml
      --snakefile Snakefile
  exit_code: 0
  stdout:
    contains:
      # Test whether the input bamfile is converted to fasta
      - samtools fasta $bamfile 2>> log/GM24385_bam_to_fasta.txt | gzip >> GM24385/input/GM24385.fasta.gz
      # Test whether we plan to convert the GFA graph to fasta
      - bp.r_utg.fasta
      # Test whether we plan to map the contigs to the reference
      - minimap2 -a tests/data/reference/ASL.fasta GM24385/assembly/GM24385.bp.r_utg.fasta
      # Test whether we plan to run blast
      - GM24385/blast/GM24385_contigs_blast.json
      # Test whether we plan to create a blast database
      - GM24385/blast/GM24385.blastdb.nhr
      # Test whether we plan to run blast
      - GM24385/blast/GM24385_blast.xml
    contains_regex:
      # Test whether the input is a single bamfile
      - 'input: tests/data/GM24385_ASL.bam$'
      # Test whether hifiasm-flags are included in the command
      - 'hifiasm -o GM24385/assembly/GM24385 .* -f0'
    must_not_contain:
      - rror
  stderr:
    must_not_contain:
      - rror

- name: dry-run-two-bamfiles
  tags:
    - dry-run
  command: >
    snakemake
      --dryrun
      --reason
      --printshellcmds
      --config pepfile=tests/pep/project_config_two_bamfiles.yml
      --snakefile Snakefile
  exit_code: 0
  stdout:
    contains_regex:
      # Test whether the input are two bamfiles
      - 'input: tests/data/GM24385_ASL.bam, tests/data/GM24385_CYP2D6-CYP2D7.bam$'
    must_not_contain:
      - rror
  stderr:
    must_not_contain:
      - rror

# Minimal configuration file, only runs HiFiasm
- name: dry-run-minimal
  tags:
    - dry-run
  command: >
    snakemake
      --dryrun
      --reason
      --printshellcmds
      --config pepfile=tests/pep/project_config_minimal.yml
      --snakefile Snakefile
  exit_code: 0
  stdout:
    must_not_contain:
      - rule map_contigs
      - rule parse_blast_results
      - rror
  stderr:
    must_not_contain:
      - rror

# Configuration file with only reference specified
- name: dry-run-reference-only
  tags:
    - dry-run
  command: >
    snakemake
      --dryrun
      --reason
      --printshellcmds
      --config pepfile=tests/pep/project_config_reference_only.yml
      --snakefile Snakefile
  exit_code: 0
  stdout:
    contains:
      - rule map_contigs
    must_not_contain:
      - rror
      - rule parse_blast_results
  stderr:
    must_not_contain:
      - rror

# Configuration file with only genes specified
- name: dry-run-genes-only
  tags:
    - dry-run
  command: >
    snakemake
      --dryrun
      --reason
      --printshellcmds
      --config pepfile=tests/pep/project_config_genes_only.yml
      --snakefile Snakefile
  exit_code: 0
  stdout:
    contains:
      - rule parse_blast_results
    must_not_contain:
      - rror
      - rule map_contigs
  stderr:
    must_not_contain:
      - rror
