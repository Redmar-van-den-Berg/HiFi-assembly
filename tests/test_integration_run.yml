- name: integration-vanilla
  tags:
    - integration
  command: >
    snakemake
      --reason
      --printshellcmds
      --jobs 1
      --latency-wait 120
      --use-singularity --singularity-args ' --cleanenv --bind /tmp'
      --config pepfile=tests/pep/project_config.yml
      --snakefile Snakefile
  stderr:
    must_not_contain:
      - rror
  files:
    # Test whether the input has been converted to fasta
    - path: GM24385/GM24385.fasta.gz
    # Test whether the log file for bam to fasta gets written
    - path: log/GM24385_bam_to_fasta.txt
      contains:
        - '[M::bam2fq_mainloop] processed 627 reads'
    # Test whether the HiFi reads were assembled
    - path: GM24385/GM24385.bp.r_utg.gfa
    # Test whether the log file for HiFiasm gets written
    - path: log/GM24385_hifiasm.txt
      contains:
        - 'M::ha_print_ovlp_stat] # overlaps:'
    # Test whether the GFA assembly was successfully converted to fasta
    - path: GM24385/GM24385.bp.r_utg.fasta
      contains:
        - ">utg"
    # Test whether the contigs were mapped to the reference
    - path: GM24385/GM24385_contigs.bam
    # Test whether bai file exists
    - path: GM24385/GM24385_contigs.bam.bai
    # Test whether the blast output files exist
    - path: GM24385/GM24385_contigs_blast.json
    - path: GM24385/GM24385_contigs_blast.fasta
    # Test whether we plan to create a blast database
    - path: GM24385/blastdb/GM24385.blastdb.nhr

# Test support for two bam files per sample
- name: integration-two-bamfiles
  tags:
    - integration
  command: >
    snakemake
      --reason
      --printshellcmds
      --jobs 1
      --latency-wait 120
      --use-singularity --singularity-args ' --cleanenv --bind /tmp'
      --config pepfile=tests/pep/project_config_two_bamfiles.yml
      --snakefile Snakefile
  stderr:
    must_not_contain:
      - rror
  files:
    # Test whether the contigs were mapped to the reference
    - path: GM24385/GM24385_contigs.bam
    # Test whether bai file exists
    - path: GM24385/GM24385_contigs.bam.bai
    # Test whether the blast results contain hits for ASL and CYP2D6
    - path: sample2/sample2_contigs_blast.fasta
      contains:
        - ">ASL NC_000007.14"
        - ">CYP2D6 LRG_303g (genomic sequence)"
      contains_regex:
        # Test presence of the best blast hit, we don't care about the contig
        # number
        - ">CYP2D6.*:14130-2816"
        - ">ASL.*:1-16454"
    # Test wether the per-gene blast output exists
    - path: GM24385/genes/ASL.fasta
    - path: sample2/genes/ASL.fasta
      contains_regex:
        # Header for the best ASL hit
        - "ASL.*utg00000.*:1-16454"
      must_not_contain_regex:
        # Header for second best ASL hit (on the same contig). Should be
        # removed
        - ">ASL.*utg00000.*:2098-1788"
    - path: sample2/genes/CYP2D6.fasta
      must_not_contain_regex:
        # Header for the best CYP2D6 hit
        - ">CYP2D6.*utg00000.*:14130-2816"
      must_not_contain_regex:
        # Header for second best CYP2D6 hit (on the same contig). Should be
        # removed
        - ">CYP2D6.*utg00000.*:21480-17998"
